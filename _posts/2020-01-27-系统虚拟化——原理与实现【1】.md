---
layout:     post
title:      系统虚拟化 
subtitle:   原理与实现【1】
date:       2020-01-27
author:     qzwerty
header-img: img/book.png
catalog: true
tags:
    - virtualization
---

## 第一章 虚拟化技术历史、分类
### 1.1 形形色色的虚拟化
计算机系统被分成了多个自下而上的层次。图1-1是一种常见的计算机系统中的抽象层。每一个层次都想向上一层次呈现一个抽象，每一层只需要知道下层抽象的接口，不需了解内部运作机制。提高软件移植性。
![1-1](https://tva1.sinaimg.cn/large/006tNbRwgy1gbb706je3uj30jc0eo77x.jpg)
如图1-1，**硬件抽象层（Hardware Abstraction Layer，HAL）**，是计算机中软件所能控制的硬件的抽象接口，包括CPU的各种寄存器、内存管理模块、I/O端口和内存映射的I/O地址等。**API抽象层** 抽象的是一个进程所能控制的系统功能的集合，包括创建新进程，内存申请和归还、进程间同步与共享、文件系统和网络操作等。

**虚拟化：** 通过向上一层软件模块提供一个与他原先所期待的运行环境完全一致的接口的方法，抽象出一个虚拟的软件或硬件接口，使得上层软件可以直接运行在虚拟环境上。
	
	虚拟化中的两个重要名词
	*宿主（Host） 物理资源
	*客户（Guest）虚拟出来的资源

*1. 硬件抽象层上的虚拟化*

客户机的大部分指令可以在宿主机处理器上直接运行，只有那些需要虚拟化的指令才会由虚拟化软件进行处理。如VMware系列产品，Xen等。

*2. 操作系统层上的虚拟化*

操作系统的内核可以提供多个互相隔离的用户态实例（常被称为容器）。对于容器上的用户来说，这些容器有自己独立的文件系统、网络、系统设置和库函数等。容器中的操作系统通常必须是同一种操作系统。大量应用在虚拟主机服务环境中。如Paralles的Virtuozzo，Solaris的Zone和Linux的VServer。

*3. 库函数层上的虚拟化*


	操作系统通常会通过应用级的库函数提供给应用程序一组服务，例如
	文件操作服务、时间操作服务等。这些库函数可以隐藏操作系统内部
	的一些细节，使得应用程序编程更简单。


通过虚拟化操作系统的应用级库函数的服务接口，是的应用程序不需要修改就能在不同操作系统中运行。如WINE系统，是在Linux上模拟了Windows的库函数接口，使得Windows程序能在Linux上正常运行。

*4. 编程语言层上的虚拟化*

语言级虚拟机，属于进程级虚拟化。程序代码由虚拟机的运行时支持系统首先翻译为硬件的机器语言，然后再执行。如JVM（Java Virtual Mashine）和微软的CLR（Common Language Runtime）。

### 1.2 系统虚拟化

![1-2](https://tva1.sinaimg.cn/large/006tNbRwgy1gbb8icv380j30rk0kyaf9.jpg)

**虚拟化层：** 虚拟机监控器（Virtual Mashine Monitor，VMM）
	
	ISA（Instruction Set Architecture，指令集架构）

对于相同体系结构的系统虚拟化，虚拟机大部分指令可以在处理器上直接运行，只有那些需要虚拟化的指令才会有VMM进行处理。但是，虚拟机和物理机可以是完全不同的ISA系统，但是这样的话，虚拟机的每一条指令都需要在物理机上模拟执行，造成性能极大下降。

	虚拟机的三个典型特征：
	*同质：虚拟机的运行环境和物理机环境本质上是相同的，但允许表现上的差异。如虚拟机看到的处理器个数可以与物理机实际个数不同，处理器主频也可以不同，但物理机和虚拟机看到的处理器必须是同一种基本类型的。
	*高效：在虚拟机上运行的软件需要有接近在物理机上直接运行的性能。软件在虚拟机中运行时，多数指令需要直接在硬件上执行，只有少量指令需要经过VMM处理。
	*资源受控：VMM需要对系统资源有完全的控制能力和管理权限，包括资源的分配、监控和回收。
	
本书围绕相同的ISA的系统虚拟化展开。

### 1.3 系统虚拟化简史
**完全虚拟化（Full Virtualization）：**虚拟机具有完全的物理计算机特性。基于软件，缺点是性能下降，伴随兼容性损失。

**半虚拟化（Partial-virtualization）：**提供对底层硬件的部分模拟，以满足某些专门的软件的执行环境，但并不能运行所有可能运行在物理机上的软件。

**类虚拟化（Para-virtualization）：**克服x86体系结构的不足（对系统虚拟化的支持缺陷或虚拟化漏洞Vitrualization Hole）。通过guest os和VMM的协同设计，由VMM软件提供一个近似于原物理系统，但又不完全相同的虚拟平台。需要修改操作系统的源代码来与下层的vmm软件协同工作。缺点是修改操作系统不适用于现有系统的移植和内核升级维护，也不适用非开源的操作系统。

**硬件辅助的完全虚拟化：**如Intel公司的VT技术和AMD公司的SVM技术，操作系统不需要做任何修改就可以运行在虚拟机中。这种策略要从处理器层到固件层，再到操作系统层对虚拟化的全面协同支持。

为了使虚拟化解决方案更加高效，计算机系统中的各个层次都在逐渐加入对虚拟化的硬件支持。以Intel为例，除了VT技术以外，芯片组中开始提供针对I/O虚拟化功能的VT-d技术，网卡中也开始提供更好的网络虚拟化支持的多队列的VMDq技术等。PCI技术也。。。（没懂）
![famous software1](https://tva1.sinaimg.cn/large/006tNbRwgy1gbbbx4enkbj30va0aen1g.jpg)
![famous software2](https://tva1.sinaimg.cn/large/006tNbRwgy1gbbbxpi834j30s80ykk7p.jpg)
![famous software3](https://tva1.sinaimg.cn/large/006tNbRwgy1gbbbxydp74j30rs0fmgs9.jpg)
云计算的一个核心思想就是在服务器端提供集中的计算资源，同时这些计算资源独立服务于不同用户，在共享的同时，为每个用户提供隔离、安全、可信的工作环境。虚拟化技术将是云计算（Cloud Computing）的一个基础架构。

### 1.4 系统虚拟化的好处

系统虚拟化提供了多个隔离的执行环境，带来的好处：
![v functions](https://tva1.sinaimg.cn/large/006tNbRwgy1gbbc9fp4g2j310u0b47a3.jpg)

*1. 封装性* 

使得虚拟机运行环境的保存非常便捷。使得以下应用模式易于实现：

* **虚拟机快照（Snapshot）**

* **虚拟机克隆（Clone）**

* **虚拟机挂起（Suspend）**：指暂停一个运行中的虚拟机，将其运行环境保存在磁盘上。

* **虚拟机恢复（Resume）**：将保存在磁盘上的虚拟机运行环境恢复到内存中以继续运行

*2. 多实例*

体现在实际应用中，产业界的服务器整合（Server Consolidation），使得多个物理服务器合并到少数几个计算机上，作为虚拟机运行，提高计算机性能的利用率。高效、节能省电、节省空间。

*3. 隔离*

应用程序在自己的操作系统独立运行，不影响其他工作负载，一个os被破坏崩溃，其他虚拟机中的应用程序仍然可以继续正常运行。支持多个用户在同一台物理服务器上对不同应用程序进行独立的操作。非常适合于测试场景，支持并行地和隔离地执行多项测试。也可作为诱饵吸引攻击。

*4. 硬件无关性*

虚拟机与底层的硬件没有直接的绑定关系，只要另一台计算机提供相同的虚拟硬件抽象层，就可以实现**虚拟机迁移**。虚拟机迁移使得物理机需要维护时不需关闭虚拟机，在计算机集群中可以将繁忙计算机上的vm迁移到空闲的计算机。可以虚拟出较旧的硬件来兼容旧系统软件。

*5. 特权功能*

VMM具有更高的特权级。如果在这个层添加_新的功能_，那么他们将具有以下的优势：

1. 高特权级，不能被guest os绕过。

2. 不需要了解guest内部的语义，实现上更容易。

研究和工业界领域的基于虚拟化特权功能特性的研究和应用：

**事件记录与回放（Log and Replay）** 

**入侵检测（Instrusion Detection）**：利用特权级别，保证检测不被guest绕过，同时guest不知道这个服务的存在。

**病毒检测**等，不用担心检测系统自身的安全，guest中的病毒很难攻击到下层。不会被绕过。







